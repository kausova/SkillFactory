4.1. База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет:
Ответ: Moscow, Ulyanovsk 

SELECT a.city
  FROM dst_project.airports a
 GROUP BY a.city
HAVING count(a.airport_code) > 1
 ORDER BY 1



4.2. 
Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. Сколько всего статусов для рейсов определено в таблице?
Ответ: 6

SELECT count(DISTINCT f.status)
  FROM dst_project.flights f


 Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).
Ответ: 58

SELECT count(*)
  FROM dst_project.flights f
 WHERE f.status = 'Departed'


Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели 773  (Boeing 777-300)?
Ответ: 402

SELECT count(s.seat_no) seats_number
  FROM dst_project.aircrafts a
  JOIN dst_project.seats s 
    ON a.aircraft_code = s.aircraft_code
 GROUP BY a.model
HAVING a.model = 'Boeing 777-300'



Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года?
Ответ: 74227

SELECT count(f.flight_id)
  FROM dst_project.flights f
 WHERE f.actual_arrival BETWEEN '2017-04-01' AND '2017-09-01'
   AND f.status = 'Arrived'

4.3. 
Вопрос 1. Сколько всего рейсов было отменено по данным базы?
Ответ: 437

SELECT count(f.flight_id)
  FROM dst_project.flights f
 WHERE f.status = 'Cancelled'


Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?
Boeing: 3

SELECT count(a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE 'Boeing%'

Sukhoi Superjet: 1

SELECT count(a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE 'Sukhoi Superjet%'

Airbus: 3

SELECT count(a.aircraft_code)
  FROM dst_project.aircrafts a
 WHERE a.model LIKE 'Airbus%'


Вопрос 3. В какой части (частях) света находится больше аэропортов?
Ответ: Europe, Asia

SELECT CASE
           WHEN a.timezone LIKE 'Europe%' THEN 'Europe'
           WHEN a.timezone LIKE 'Asia%' THEN 'Asia'
           ELSE 'Other'
       END AS zone,
       count(a.airport_code)
  FROM dst_project.airports a
 GROUP BY zone


Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).
Ответ: 157571

SELECT f.flight_id,
       (f.actual_arrival - f.scheduled_arrival) AS delay
 FROM dst_project.flights f
WHERE f.status = 'Arrived'
ORDER BY 2 DESC
LIMIT 1

4.4.
Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?
Ответ: 14.08.2016 

SELECT min(f.scheduled_departure)
  FROM dst_project.flights f

Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе?
Ответ: 530

SELECT extract(epoch FROM (f.scheduled_arrival - f.scheduled_departure)) / 60 flight_minutes
  FROM dst_project.flights f
 ORDER BY 1 DESC
 LIMIT 1


Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс?
Ответ: DME - UUS 

SELECT DISTINCT f.departure_airport,
                f.arrival_airport,
                (f.scheduled_arrival - f.scheduled_departure) AS flight_time
  FROM dst_project.flights f
 ORDER BY 3 DESC
 LIMIT 4

Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут).
Ответ: 128

SELECT ROUND(AVG(EXTRACT(epoch FROM (f.scheduled_arrival - f.scheduled_departure)) / 60))
  FROM dst_project.flights f

4.5.
Вопрос 1. Мест какого класса у SU9 больше всего?
Ответ: Economy

SELECT s.fare_conditions,
       count(s.seat_no)
  FROM dst_project.seats s
 WHERE s.aircraft_code = 'SU9'
 GROUP BY s.fare_conditions
 ORDER BY 2 DESC

Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю?
Ответ: 3400

SELECT min(b.total_amount)
  FROM dst_project.bookings b

Вопрос 3. Какой номер места был у пассажира с id = 4313 788533?
Ответ: 2A

SELECT b.seat_no
  FROM dst_project.boarding_passes b
  LEFT JOIN dst_project.tickets t ON b.ticket_no = t.ticket_no
 WHERE passenger_id = '4313 788533'



5.1.
Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?
Ответ: 486

SELECT count(*)
  FROM dst_project.flights f
  LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
 WHERE a.city = 'Anapa'
   AND (f.actual_arrival BETWEEN '2017-01-01' AND '2017-12-31')

Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?
Ответ: 127

SELECT count(*)
  FROM dst_project.flights f
 WHERE f.departure_airport = 'AAQ'
   AND scheduled_departure BETWEEN '2017-01-01' AND '2017-03-01'


Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время.
Ответ: 1

SELECT count(*)
  FROM dst_project.flights f
  LEFT JOIN dst_project.airports a ON f.departure_airport = a.airport_code
 WHERE a.city = 'Anapa'
   AND f.status = 'Cancelled'

Вопрос 4. Сколько рейсов из Анапы не летают в Москву?
Ответ: 453

SELECT count(flight_id)
  FROM dst_project.flights f
  LEFT JOIN dst_project.airports a ON f.arrival_airport = a.airport_code
 WHERE f.departure_airport = 'AAQ'
   AND a.city != 'Moscow'

Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?
Ответ: Boeing 737-300

WITH t AS
/* Таблица с к-вом мест для каждой модели самолета (код) */
(
SELECT
	s.aircraft_code,
	count(s.seat_no) count_seat
	FROM dst_project.seats s 
	GROUP BY s.aircraft_code
)
SELECT 
	a.model,
   	t.count_seat
	FROM dst_project.flights f 
  	JOIN t 
	     ON f.aircraft_code = t.aircraft_code -- объединяем таблицы для вывода к-ва мест для каждого рейса, исходя из модели самолета
  	JOIN dst_project.aircrafts a 
	     ON f.aircraft_code = a.aircraft_code -- объединяем таблицы для вывода названия модели самолета
WHERE f.departure_airport = 'AAQ' -- выделяем только интересующие нас рейсы из Анапы 
GROUP BY 
	a.model,
	t.count_seat
ORDER BY 2 DESC
LIMIT 1



